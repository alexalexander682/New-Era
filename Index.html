<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live AI Debugger â€“ MVP</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/@codemirror/view@6.24.0/dist/style.css">
  <style>
    :root {
      --bg: #0f1220; --panel: #151936; --ink: #e8eaf6; --muted:#aab1d6;
      --accent:#7c9cff; --ok:#25d0a6; --err:#ff6b6b; --warn:#ffc857;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; background: linear-gradient(180deg,#0b0f1e, #0f1220);
      color: var(--ink); font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
    }
    header {
      padding: 16px 20px; border-bottom: 1px solid #20264d;
      display:flex; align-items:center; gap:14px;
      position: sticky; top:0; background: rgba(15,18,32,.85); backdrop-filter: blur(8px);
    }
    header h1 { font-size: 16px; margin: 0; letter-spacing:.3px; }
    header .badge { padding: 2px 8px; border-radius: 999px; background: #222a57; color: var(--muted); }
    main { display:grid; grid-template-columns: 1.2fr .8fr; gap: 12px; padding: 12px; height: calc(100vh - 64px); }
    .panel { background: var(--panel); border: 1px solid #22285b; border-radius: 10px; min-height: 120px; overflow: hidden; display:flex; flex-direction:column; }
    .panel header { background: #171c3f; border: none; padding: 10px 12px; }
    .panel header h2 { margin:0; font-size:13px; color: var(--muted); }
    .toolbar { display:flex; gap:8px; align-items:center; }
    button {
      background: #1b2150; color: var(--ink); border: 1px solid #283174;
      padding: 7px 10px; border-radius: 8px; cursor: pointer;
    }
    button:hover { border-color:#3852ff; }
    button.accent { background: var(--accent); border-color: transparent; color:#0b0f1e; font-weight: 600; }
    .editor { flex: 1; overflow: auto; }
    .output, .suggestions { flex:1; padding: 10px; overflow: auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0f1230; }
    .row { display:flex; align-items:center; gap:8px; }
    .log{ white-space: pre-wrap; border-bottom:1px dashed #2a2f63; padding:6px 0; }
    .log .tag { font-size:11px; padding:2px 6px; border-radius:6px; margin-right:6px; opacity:.9 }
    .tag.info{ background:#1b2a55; color:#9db2ff; }
    .tag.err{ background:#3a1d2a; color:#ff93a1; }
    .tag.warn{ background:#3a2f1d; color:#ffd38a; }
    .hint { border-left: 3px solid var(--warn); padding: 6px 10px; margin: 8px 0; background:#181f47;}
    .hint.ok { border-color: var(--ok); }
    .hint.err { border-color: var(--err); }
    .footer { padding: 8px 10px; border-top: 1px solid #22285b; color: var(--muted); }
    iframe.runner { width: 0; height: 0; border: 0; position: absolute; left: -9999px; }
    .pill { padding: 2px 8px; border-radius:999px; background:#1e2452; color:#a9b2ff; }
    .right-header { margin-left:auto; display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <header>
    <h1>Live AI Debugger <span class="badge">MVP</span></h1>
    <span class="pill">Sandboxed</span>
    <div class="right-header">
      <button id="runBtn" class="accent">Run â–¶</button>
      <button id="formatBtn">Format</button>
      <button id="clearBtn">Clear Output</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <header><h2>Editor (JavaScript)</h2></header>
      <div id="editor" class="editor"></div>
      <div class="footer">Autoâ€‘run on pause (500 ms) â€¢ Press <b>Run</b> to force execution</div>
    </section>

    <section class="panel">
      <header><h2>Runtime & Suggestions</h2></header>
      <div class="output" id="output"></div>
      <div class="suggestions" id="suggestions"></div>
      <div class="footer">Logs + errors above â€¢ Heuristic & AI suggestions below</div>
    </section>
  </main>

  <iframe sandbox="allow-scripts" class="runner" id="runner"></iframe>

  <!-- CodeMirror (lightweight essentials) -->
  <script type="module">
    import {EditorView, keymap, highlightActiveLine} from "https://unpkg.com/@codemirror/view@6.24.0/dist/index.js";
    import {EditorState} from "https://unpkg.com/@codemirror/state@6.4.1/dist/index.js";
    import {javascript} from "https://unpkg.com/@codemirror/lang-javascript@6.2.1/dist/index.js";
    import {defaultKeymap, history, historyKeymap} from "https://unpkg.com/@codemirror/commands@6.6.0/dist/index.js";
    import {indentWithTab} from "https://unpkg.com/@codemirror/commands@6.6.0/dist/keymap.js";

    // --- UI elements ---
    const outputEl = document.getElementById('output');
    const suggEl = document.getElementById('suggestions');
    const runBtn = document.getElementById('runBtn');
    const clearBtn = document.getElementById('clearBtn');
    const formatBtn = document.getElementById('formatBtn');
    const runner = document.getElementById('runner');

    // --- Editor setup ---
    const initialCode = `// Try some code with bugs ðŸ‘‡
function greet(name) {
  // Intentional bug: userName is not defined
  return "Hello, " + userName.toUpperCase();
}

console.log(greet("Ada"));
// Another: TypeError possibility:
// const x = null; console.log(x.toString());
`;

    let view = new EditorView({
      state: EditorState.create({
        doc: initialCode,
        extensions: [
          javascript(),
          history(),
          highlightActiveLine(),
          keymap.of([indentWithTab, ...defaultKeymap, ...historyKeymap]),
          EditorView.theme({
            '&': { height: '100%' },
            '.cm-content': { fontFamily: 'ui-monospace, SFMono-Regular, Menlo, Consolas, monospace', fontSize: '13px' },
            '.cm-line': { padding: '0 8px' }
          },{dark:true})
        ]
      }),
      parent: document.getElementById('editor')
    });

    // --- Runner bootstrap (isolated iframe) ---
    function ensureRunner() {
      const html = `
<!doctype html><meta charset="utf-8">
<script>
  (function () {
    const send = (type, payload) => parent.postMessage({ type, payload }, "*");
    // Intercept console
    ['log','info','warn','error'].forEach(k=>{
      const orig = console[k].bind(console);
      console[k] = (...args) => {
        try { send('console', { level:k, args: args.map(safe) }); } catch(e){}
        orig(...args);
      };
    });
    // Make values postMessage-safe
    function safe(v){
      try {
        if (v === undefined) return 'undefined';
        if (v instanceof Error) return v.name + ': ' + v.message + '\\n' + (v.stack||'');
        if (typeof v === 'function') return '[Function ' + (v.name||'anonymous') + ']';
        return JSON.stringify(v, getCircularReplacer(), 2);
      } catch { return String(v); }
    }
    function getCircularReplacer() {
      const seen = new WeakSet();
      return (key, value) => {
        if (typeof value === "object" && value !== null) {
          if (seen.has(value)) return "[Circular]";
          seen.add(value);
        }
        return value;
      };
    }
    window.addEventListener('error', (e)=>{
      send('runtimeError', { message:e.message, filename:e.filename, lineno:e.lineno, colno:e.colno, stack:e.error && e.error.stack });
    });
    window.addEventListener('unhandledrejection', (e)=>{
      const err = e.reason instanceof Error ? (e.reason.name + ': ' + e.reason.message + '\\n' + (e.reason.stack||'')) : String(e.reason);
      send('runtimeError', { message: 'UnhandledPromiseRejection: ' + err });
    });
    window.addEventListener('message', (e)=>{
      if (!e.data || e.data.type !== 'execute') return;
      const code = e.data.code + "\\n//# sourceURL=usercode.js";
      try {
        const fn = new Function(code);
        fn();
        send('done', {});
      } catch (err) {
        send('runtimeError', { message: err && err.message, stack: err && err.stack, name: err && err.name });
      }
    });
    // Ack ready
    send('ready',{});
  })();
<\/script>`;
      runner.srcdoc = html;
    }
    ensureRunner();

    // --- Messaging bridge ---
    window.addEventListener('message', (e)=>{
      const {type, payload} = e.data || {};
      if (type === 'console') {
        logLine(payload.level, ...payload.args);
      } else if (type === 'runtimeError') {
        logError(payload);
        diagnose(payload, view.state.doc.toString());
      } else if (type === 'ready') {
        // Optionally indicate runner ready
      } else if (type === 'done') {
        // no-op
      }
    });

    // --- Logging UI ---
    function logLine(level, ...args){
      const div = document.createElement('div');
      div.className = 'log';
      const tag = document.createElement('span');
      tag.className = 'tag ' + (level==='warn'?'warn':level==='error'?'err':'info');
      tag.textContent = level.toUpperCase();
      div.appendChild(tag);
      div.appendChild(document.createTextNode(' ' + args.join(' ')));
      outputEl.appendChild(div);
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    function logError(errObj){
      const div = document.createElement('div');
      div.className = 'log';
      const tag = document.createElement('span');
      tag.className = 'tag err';
      tag.textContent = 'ERROR';
      const msg = (errObj.name ? errObj.name + ': ' : '') + (errObj.message || 'Error');
      const stack = errObj.stack ? '\n' + errObj.stack : '';
      div.appendChild(tag);
      div.appendChild(document.createTextNode(' ' + msg + stack));
      outputEl.appendChild(div);
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    function clearOutput(){
      outputEl.innerHTML = '';
      suggEl.innerHTML = '';
    }

    clearBtn.onclick = clearOutput;

    // --- Runner control ---
    function runCode(){
      // Rebuild runner each run for a clean env (cheap for MVP)
      ensureRunner();
      setTimeout(()=>{
        runner.contentWindow.postMessage({ type:'execute', code: view.state.doc.toString() }, "*");
      }, 0);
      suggEl.innerHTML = '';
      logLine('info', 'Runningâ€¦');
    }

    runBtn.onclick = runCode;

    // Debounced autorun
    let t;
    function scheduleRun(){
      clearTimeout(t);
      t = setTimeout(runCode, 500);
    }
    view.dom.addEventListener('keyup', scheduleRun);

    // --- Simple formatter (very naive) ---
    formatBtn.onclick = () => {
      const code = view.state.doc.toString();
      const pretty = code
        .replace(/;(?=\S)/g, '; ')       // space after ;
        .replace(/\{(?=\S)/g, '{ ')      // space after {
        .replace(/(?<=\S)\{/g, ' {')     // space before {
        .replace(/[ \t]+$/gm, '')        // trim right
        .replace(/\n{3,}/g, '\n\n');     // limit blank lines
      view.dispatch({ changes: { from: 0, to: view.state.doc.length, insert: pretty }});
    };

    // --- Heuristic diagnostics (demo) ---
    function diagnose(runtimeErr, code){
      const hints = [];
      const msg = (runtimeErr && runtimeErr.message) || '';

      // ReferenceError: X is not defined
      const ref = msg.match(/ReferenceError:\s*([A-Za-z_$][\w$]*) is not defined/);
      if (ref) {
        const name = ref[1];
        const nearLine = findFirstOccurrenceLine(code, name);
        hints.push({
          kind:'err',
          title:`'${name}' is not defined`,
          details:`Declare '${name}' or correct the identifier.`,
          actions:[
            {label:`Declare const ${name}`, patch:`const ${name} = /* TODO */;\n` , line:nearLine}
          ]
        });
      }

      // TypeError: Cannot read properties of X (reading 'toUpperCase')
      const typeMatch = msg.match(/TypeError:\s*Cannot (?:read|set) properties? of (.+?) \(reading '([\w$]+)'\)/);
      if (typeMatch) {
        const reading = typeMatch[2];
        hints.push({
          kind:'warn',
          title:`Potential null/undefined before '${reading}'`,
          details:`Add a guard or optional chaining before using '${reading}'.`,
          actions:[
            {label:'Add optional chaining', patch:`// e.g. obj?.${reading}?.(/* args */)`}
          ]
        });
      }

      // SyntaxError
      if (/SyntaxError:/.test(msg)) {
        hints.push({
          kind:'err',
          title:'Syntax error',
          details:'Check brackets, commas, and missing parentheses. Running a proper parser would pinpoint this.',
          actions:[{label:'Run ESLint/Prettier', patch:'// configure ESLint/Prettier in real build'}]
        });
      }

      // Add one AI suggestion placeholder (wire to your LLM)
      hints.push({
        kind:'ok',
        title:'AI suggestion',
        details:'(Demo) This would call an LLM to propose a concrete fix with rationale.',
        actions:[{label:'Call analyzeWithLLM()', patch:'// See analyzeWithLLM() impl below'}]
      });

      renderHints(hints);
    }

    function renderHints(hints){
      suggEl.innerHTML = '';
      for (const h of hints) {
        const box = document.createElement('div');
        box.className = 'hint ' + (h.kind==='err'?'err':h.kind==='warn'?'':'ok');
        const title = document.createElement('div');
        title.style.fontWeight = '600';
        title.textContent = h.title;
        const details = document.createElement('div');
        details.style.opacity = .9;
        details.textContent = h.details;
        const row = document.createElement('div'); row.className = 'row'; row.style.marginTop = '6px';

        (h.actions||[]).forEach(a=>{
          const btn = document.createElement('button');
          btn.textContent = a.label;
          btn.onclick = () => applyPatch(a.patch, a.line);
          row.appendChild(btn);
        });

        box.appendChild(title); box.appendChild(details); box.appendChild(row);
        suggEl.appendChild(box);
      }
    }

    function applyPatch(patch, line){
      const doc = view.state.doc.toString().split('\n');
      const idx = Math.max(0, (line ?? 0));
      doc.splice(idx, 0, patch);
      const next = doc.join('\n');
      view.dispatch({ changes: { from: 0, to: view.state.doc.length, insert: next }});
      scheduleRun();
    }

    function findFirstOccurrenceLine(code, name){
      const lines = code.split('\n');
      for (let i=0;i<lines.length;i++){
        if (lines[i].includes(name)) return i;
      }
      return 0;
    }

    // --- AI hook (wire this to your model provider) ---
    async function analyzeWithLLM(problemSummary, code){
      // TODO: plug in your API of choice. Keep PII out; hash file paths; strip secrets.
      // Example sketch:
      /*
      const res = await fetch("YOUR_ENDPOINT", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization":"Bearer X" },
        body: JSON.stringify({ problemSummary, code, rules:["succinct","show diff","explain risk"] })
      }).then(r=>r.json());
      return res;
      */
      return { suggestions: ["(LLM) Example: It looks like 'userName' should be 'name'. Replace it and add a null-check."] };
    }

    // Kick first run
    runCode();
  </script>
</body>
</html>
